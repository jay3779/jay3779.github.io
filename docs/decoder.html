<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, viewport-fit=cover">
<meta name="description" content="itty bitty decoder - self-hosted">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='1em' height='1em'><text y='.9em'>üì¶</text></svg>" id="favicon">
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  margin: 0;
  background: #fff;
}
#iframe {
  border: none;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
#loader {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 40px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  text-align: center;
  z-index: 1000;
}
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.hidden { display: none !important; }
</style>
<meta id="themeColor" name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta id="themeColorDark" name="theme-color" content="#16161D" media="(prefers-color-scheme: dark)">
</head>
<body>
<div id="loader">
  <div class="spinner"></div>
  <p>Loading decoder...</p>
</div>
<iframe id="iframe" class="hidden"></iframe>

<script>
// Load pako for decompression
const pakoScript = document.createElement('script');
pakoScript.src = 'https://cdn.jsdelivr.net/npm/pako@2/dist/pako.min.js';
pakoScript.onload = decodeFromHash;
pakoScript.onerror = () => {
  document.getElementById('loader').innerHTML = '<h1>Error</h1><p>Failed to load decoder library</p>';
};
document.head.appendChild(pakoScript);

function base64ToUint8Array(b64) {
  const bstr = atob(b64.replace(/[^A-Za-z0-9+/=]/g, ''));
  const bytes = new Uint8Array(bstr.length);
  for (let i = 0; i < bstr.length; i++) {
    bytes[i] = bstr.charCodeAt(i);
  }
  return bytes;
}

function decodeFromHash() {
  const hash = window.location.hash.substring(1);
  const loader = document.getElementById('loader');
  const iframe = document.getElementById('iframe');
  
  if (!hash) {
    loader.innerHTML = '<h1>itty bitty Decoder</h1><p>No content specified. Share a link with content hash.</p>';
    return;
  }

  try {
    const parts = hash.split('/');
    let title = 'Content';
    let compressedB64 = hash;

    if (parts.length > 1) {
      title = decodeURIComponent(parts[0].replace(/\+/g, ' '));
      compressedB64 = parts.slice(1).join('/');
    }

    const compressedBytes = base64ToUint8Array(compressedB64);
    
    let decompressed;
    try {
      decompressed = pako.inflate(compressedBytes, { to: 'string' });
    } catch(e) {
      try {
        decompressed = pako.ungzip(compressedBytes, { to: 'string' });
      } catch(e2) {
        throw new Error('Decompression failed: ' + e2.message);
      }
    }

    document.title = title + ' - itty bitty';
    loader.classList.add('hidden');
    iframe.classList.remove('hidden');
    
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    iframeDoc.open();
    iframeDoc.write(decompressed);
    iframeDoc.close();

  } catch (error) {
    loader.innerHTML = '<h1>Decode Error</h1><p style="color:red;">' + error.message + '</p>';
  }
}

window.addEventListener('hashchange', decodeFromHash);
</script>
</body>
</html>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .decoder-container {
      background: white;
      border-radius: 12px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 2em;
    }

    #content {
      margin-top: 30px;
      line-height: 1.6;
      color: #333;
    }

    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #c33;
      margin-top: 20px;
    }

    .metadata {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.9em;
      color: #666;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="decoder-container">
    <a href="/" class="back-link">‚Üê Back to Blog</a>
    <h1 id="title">Post</h1>
    <div class="metadata">
      <strong>Title:</strong> <span id="metaTitle">‚Äî</span><br>
      <strong>URL:</strong> <code id="metaUrl" style="word-break: break-all; font-size: 0.85em;"></code>
    </div>
    <div id="content" class="loading">Decoding post...</div>
  </div>

  <script>
    // Polyfill for atob that handles larger inputs
    function base64ToUint8Array(base64) {
      const binary = atob(base64.replace(/[^A-Za-z0-9+/=]/g, ''));
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    // Decompress using pako (if available) or a fallback
    async function decompressData(compressedData) {
      // Try to load pako if not already loaded
      if (typeof pako === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/pako@2/dist/pako.min.js';
        document.head.appendChild(script);
        
        return new Promise((resolve) => {
          script.onload = () => {
            try {
              const decompressed = pako.inflate(compressedData);
              resolve(new TextDecoder().decode(decompressed));
            } catch (e) {
              resolve(null);
            }
          };
        });
      }

      try {
        const decompressed = pako.inflate(compressedData);
        return new TextDecoder().decode(decompressed);
      } catch (e) {
        return null;
      }
    }

    async function decodePost() {
      try {
        const hash = window.location.hash.substring(1);
        const contentDiv = document.getElementById('content');
        const titleEl = document.getElementById('title');

        if (!hash) {
          contentDiv.innerHTML = '<div class="error">No post data provided. Use format: #Title/base64encodedcompressed</div>';
          return;
        }

        // Parse URL format: Title/CompressedContent or just CompressedContent
        const parts = hash.split('/');
        let title = 'Post';
        let compressedB64 = hash;

        if (parts.length > 1) {
          title = decodeURIComponent(parts[0]);
          compressedB64 = parts.slice(1).join('/');
        }

        titleEl.textContent = title;
        document.getElementById('metaTitle').textContent = title;
        document.getElementById('metaUrl').textContent = window.location.href;

        // Decode base64 to bytes
        const compressedBytes = base64ToUint8Array(compressedB64);

        // Decompress the data
        const decompressed = await decompressData(compressedBytes);

        if (!decompressed) {
          contentDiv.innerHTML = '<div class="error">Failed to decompress post data. The data may be corrupted or use an unsupported compression format.</div>';
          return;
        }

        // Display the content (could be HTML or plain text)
        if (decompressed.trim().startsWith('<')) {
          // It's HTML
          contentDiv.innerHTML = decompressed;
        } else {
          // It's plain text
          contentDiv.innerHTML = '<pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto;">' + 
                                  decompressed.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
                                  '</pre>';
        }
      } catch (error) {
        console.error('Decode error:', error);
        document.getElementById('content').innerHTML = 
          '<div class="error">Error decoding post: ' + error.message + '</div>';
      }
    }

    // Decode on page load
    window.addEventListener('hashchange', decodePost);
    decodePost();
  </script>
</body>
</html>
